    - name: Upload Dependabot Alerts to DefectDojo
      env:
        GH_TOKEN: ${{ secrets.GH_SECURITY_TOKEN }}
        DEFECTDOJO_API_TOKEN: ${{ secrets.DEFECTDOJO_API_TOKEN }}
        DEFECTDOJO_URL: ${{ env.DEFECTDOJO_URL }}
      run: |
        curl -s -H "Authorization: token $GH_TOKEN" \
             -H "Accept: application/vnd.github+json" \
             https://api.github.com/repos/${{ github.repository }}/dependabot/alerts \
             -o raw-dependabot-alerts.json

        python3 <<EOF
import json
import csv

with open("raw-dependabot-alerts.json") as f:
    alerts = json.load(f)

with open("dependabot.csv", "w") as out:
    writer = csv.writer(out)
    writer.writerow(["Vulnerability ID", "Package", "Severity", "URL", "Summary"])
    for alert in alerts:
        writer.writerow([
            alert.get("security_advisory", {}).get("ghsa_id", "N/A"),
            alert.get("security_vulnerability", {}).get("package", {}).get("name", "N/A"),
            alert.get("security_vulnerability", {}).get("severity", "UNKNOWN"),
            alert.get("html_url", ""),
            alert.get("security_advisory", {}).get("summary", "")
        ])
EOF

        curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
          -H "Authorization: Token $DEFECTDOJO_API_TOKEN" \
          -F "scan_type=Generic Findings Import" \
          -F "engagement=4" \
          -F "file=@dependabot.csv" \
          -F "active=true" \
          -F "verified=true"
